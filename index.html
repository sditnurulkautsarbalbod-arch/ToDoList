
<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>To-Do List SD IT Nurul Kautsar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-10px);
      }
      60% {
        transform: translateY(-5px);
      }
    }
    
    @keyframes checkmark {
      0% {
        transform: scale(0);
      }
      50% {
        transform: scale(1.2);
      }
      100% {
        transform: scale(1);
      }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .slide-in {
      animation: slideIn 0.5s ease-out;
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    
    .bounce {
      animation: bounce 0.6s ease-in-out;
    }
    
    .checkmark-animation {
      animation: checkmark 0.3s ease-out;
    }

    .loading-spinner {
      border: 2px solid #f3f4f6;
      border-top: 2px solid #3b82f6;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
    }
    .task-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .checkbox-custom {
        appearance: none;
        width: 20px;
        height: 20px;
        border: 2px solid #10b981;
        border-radius: 4px;
        position: relative;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .checkbox-custom:checked {
        background-color: #10b981;
        border-color: #10b981;
    }
    .checkbox-custom:checked::after {
        content: '‚úì';
        position: absolute;
        top: -2px;
        left: 2px;
        color: white;
        font-size: 14px;
        font-weight: bold;
    }
  </style>
  <!-- React and Babel for in-browser JSX transformation -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="h-full bg-gradient-to-br from-blue-50 to-indigo-100 font-sans">
  <div id="root"></div>

  <script type="text/babel">
    // --- SERVICES ---
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxAyGHSJWcRaYb0ZmGD9ub-wv2KKeoPcyr4RnOKdiQjjSbr-xYJPnyC1OvfD8a8ybN5_Q/exec';

    const apiRequest = async (action, payload) => {
      const options = {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action, ...payload }),
        redirect: 'follow',
      };

      try {
        const response = await fetch(SCRIPT_URL, options);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        if (result.status === 'error') throw new Error(result.message || 'An unknown API error occurred');
        return result.data;
      } catch (error) {
        console.error(`API Error on action '${action}':`, error);
        throw error;
      }
    };

    const getTasks = async () => {
      try {
        const response = await fetch(SCRIPT_URL);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        if (result.status === 'error') throw new Error(result.message || 'An unknown API error occurred');
        return result.data || [];
      } catch (error) {
        console.error('API Error on getTasks:', error);
        throw error;
      }
    };

    const createTask = (taskData) => apiRequest('create', { data: taskData });
    const updateTask = (taskData) => apiRequest('update', { data: taskData });
    const deleteTask = (id) => apiRequest('delete', { id });

    // --- UTILS ---
    const isTaskEnded = (task) => {
      if (!task.hasEndDate || !task.endDate) return false;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const endDate = new Date(task.endDate);
      return endDate < today;
    };

    const sortTasksByPriority = (tasks) => {
      return [...tasks].sort((a, b) => {
        const getPriority = (task) => {
          const ended = isTaskEnded(task);
          const completed = task.completed;
          if (!ended && !completed) return 1;
          if (ended && !completed) return 2;
          if (!ended && completed) return 3;
          if (ended && completed) return 4;
          return 5;
        };
        const aPriority = getPriority(a);
        const bPriority = getPriority(b);
        if (aPriority === bPriority) {
          const aStartDate = new Date(a.startDate).getTime();
          const bStartDate = new Date(b.startDate).getTime();
          return bStartDate - aStartDate;
        }
        return aPriority - bPriority;
      });
    };

    // --- COMPONENTS ---
    const PlusIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
      </svg>
    );

    const TrashIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
      </svg>
    );

    const BackIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
      </svg>
    );
    
    const Spinner = ({ className = '' }) => {
      return <div className={`loading-spinner ${className}`}></div>;
    };

    const TaskItem = ({ task, onToggle, onDelete }) => {
      const startDate = new Date(task.startDate).toLocaleDateString('id-ID');
      const endDate = task.hasEndDate && task.endDate ? new Date(task.endDate).toLocaleDateString('id-ID') : '';
      const dateDisplay = task.hasEndDate ? `${startDate} - ${endDate}` : `${startDate} - Tanpa akhir`;

      const ended = isTaskEnded(task);
      const statusIcon = ended ? '‚è∞' : 'üîÑ';
      const statusText = ended ? 'Berakhir' : 'Berjalan';
      const statusColor = ended ? 'text-red-500' : 'text-green-500';

      return (
        <div className="task-item bg-gray-50 rounded-lg p-4 border border-gray-200 fade-in hover:shadow-md transition-shadow duration-300">
          <div className="flex items-start gap-3">
            <input
              type="checkbox"
              className={`checkbox-custom ${task.completed ? 'checkmark-animation' : ''} mt-1 flex-shrink-0`}
              checked={task.completed}
              onChange={() => onToggle(task.id, !task.completed)}
            />
            <div className="flex-1 min-w-0">
              <span className={`block break-words ${task.completed ? 'text-gray-400 line-through' : 'text-gray-800'} font-medium`}>
                {task.text}
              </span>
              <div className="text-xs text-gray-500 mt-1 flex items-center gap-2 flex-wrap">
                <div className="flex items-center gap-1">
                  <span>üìÖ</span>
                  <span>{dateDisplay}</span>
                </div>
                <div className={`flex items-center gap-1 ${statusColor}`}>
                  <span>{statusIcon}</span>
                  <span>{statusText}</span>
                </div>
              </div>
            </div>
            <button
              onClick={() => onDelete(task.id)}
              className="text-gray-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition-all flex-shrink-0"
              title="Hapus tugas"
            >
              <TrashIcon className="w-5 h-5" />
            </button>
          </div>
        </div>
      );
    };

    const TaskList = ({ tasks, isLoading, onToggleTask, onDeleteTask, onShowAddTask }) => {
      const completedCount = tasks.filter(task => task.completed).length;
      const sortedTasks = sortTasksByPriority(tasks);

      return (
        <div className="max-w-md mx-auto bg-white rounded-2xl shadow-xl overflow-hidden slide-in">
          <header className="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-white">
            <h1 className="text-2xl font-bold text-center mb-2">üìö Daftar Tugas</h1>
            <p className="text-center text-blue-100 text-sm mb-4">SD IT Nurul Kautsar</p>
            <button
              onClick={onShowAddTask}
              className="w-full px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-lg transition-all transform hover:scale-105 font-medium flex items-center justify-center gap-2"
            >
              <PlusIcon className="w-5 h-5" />
              <span>Tambah Tugas</span>
            </button>
          </header>

          <div className="p-6">
            {isLoading && (
              <div className="flex justify-center items-center py-8">
                <Spinner />
                <p className="ml-2 text-gray-500">Memuat tugas...</p>
              </div>
            )}

            {!isLoading && tasks.length === 0 && (
              <div id="empty-state" className="text-center py-8 text-gray-500">
                <div className="text-4xl mb-3">üìù</div>
                <p className="text-lg font-medium mb-2">Belum ada tugas</p>
                <p className="text-sm">Klik "Tambah Tugas" untuk memulai!</p>
              </div>
            )}
            
            {!isLoading && tasks.length > 0 && (
              <>
                <div id="tasks-container" className="space-y-3">
                  {sortedTasks.map(task => (
                    <TaskItem
                      key={task.id}
                      task={task}
                      onToggle={onToggleTask}
                      onDelete={onDeleteTask}
                    />
                  ))}
                </div>
                <div id="task-counter" className="mt-6 text-center text-sm text-gray-600">
                  <span id="completed-count">{completedCount}</span> dari <span id="total-count">{tasks.length}</span> tugas selesai
                </div>
              </>
            )}
          </div>
        </div>
      );
    };
    
    const AddTaskForm = ({ onAddTask, onCancel }) => {
      const { useState } = React;
      const [text, setText] = useState('');
      const [startDate, setStartDate] = useState(new Date().toISOString().split('T')[0]);
      const [endDate, setEndDate] = useState('');
      const [hasEndDate, setHasEndDate] = useState(true);
      const [isSubmitting, setIsSubmitting] = useState(false);

      const handleNoEndDateChange = (e) => {
        setHasEndDate(!e.target.checked);
        if (e.target.checked) setEndDate('');
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!text.trim() || !startDate || isSubmitting) return;

        if (hasEndDate && endDate && new Date(endDate) < new Date(startDate)) {
          alert('Tanggal berakhir tidak boleh lebih awal dari tanggal mulai!');
          return;
        }

        setIsSubmitting(true);
        const newTask = {
          text: text.trim(),
          startDate,
          endDate: hasEndDate ? endDate : null,
          hasEndDate,
        };
        
        try {
            await onAddTask(newTask);
            // On success, the view will change, so we don't need to reset the form state here.
        } catch (error) {
            // On failure, stay on the form and allow the user to try again.
            setIsSubmitting(false);
        }
      };

      return (
        <div className="max-w-md mx-auto bg-white rounded-2xl shadow-xl overflow-hidden slide-in">
          <header className="bg-gradient-to-r from-green-600 to-emerald-600 p-6 text-white">
            <div className="flex items-center gap-3">
              <button onClick={onCancel} className="p-2 hover:bg-white hover:bg-opacity-20 rounded-full transition-all" title="Kembali">
                <BackIcon className="w-6 h-6" />
              </button>
              <h1 className="text-xl font-bold flex-1 text-center">Tambah Tugas Baru</h1>
              <div className="w-10"></div>
            </div>
          </header>
          <div className="p-6">
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label htmlFor="task-input" className="block text-sm font-medium text-gray-700 mb-2">Nama Tugas</label>
                <input
                  type="text"
                  id="task-input"
                  value={text}
                  onChange={(e) => setText(e.target.value)}
                  placeholder="Tulis tugas baru..."
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                  required
                />
              </div>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label htmlFor="start-date" className="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai</label>
                  <input
                    type="date"
                    id="start-date"
                    value={startDate}
                    onChange={(e) => setStartDate(e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all text-sm"
                    required
                  />
                </div>
                <div>
                  <label htmlFor="end-date" className="block text-sm font-medium text-gray-700 mb-1">Tanggal Berakhir</label>
                  <input
                    type="date"
                    id="end-date"
                    value={endDate}
                    onChange={(e) => setEndDate(e.target.value)}
                    disabled={!hasEndDate}
                    className={`w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all text-sm ${!hasEndDate ? 'opacity-50 cursor-not-allowed' : ''}`}
                  />
                </div>
              </div>
              <div className="flex items-center gap-2">
                <input
                  type="checkbox"
                  id="no-end-date"
                  className="h-4 w-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500"
                  checked={!hasEndDate}
                  onChange={handleNoEndDateChange}
                />
                <label htmlFor="no-end-date" className="text-sm text-gray-600">Tanpa akhir</label>
              </div>
              <div className="flex gap-3 pt-4">
                <button
                  type="button"
                  onClick={onCancel}
                  className="flex-1 px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-all font-medium"
                >
                  Batal
                </button>
                <button
                  type="submit"
                  id="add-button"
                  disabled={isSubmitting}
                  className="flex-1 px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg hover:from-green-600 hover:to-emerald-600 focus:outline-none focus:ring-2 focus:ring-green-500 transition-all transform hover:scale-105 font-medium flex justify-center items-center disabled:opacity-75"
                >
                  {isSubmitting ? (
                    <>
                      <Spinner className="mr-2 border-t-white" />
                      <span>Menyimpan...</span>
                    </>
                  ) : (
                    <span>Simpan</span>
                  )}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // --- MAIN APP ---
    const App = () => {
      const { useState, useEffect, useCallback } = React;
      const [tasks, setTasks] = useState([]);
      const [isLoading, setIsLoading] = useState(true);
      const [error, setError] = useState(null);
      const [view, setView] = useState('list');

      const fetchTasks = useCallback(async () => {
        setIsLoading(true);
        setError(null);
        try {
          const fetchedTasks = await getTasks();
          setTasks(Array.isArray(fetchedTasks) ? fetchedTasks : []);
        } catch (err) {
          setError('Gagal memuat tugas. Periksa koneksi internet Anda.');
          console.error(err);
        } finally {
          setIsLoading(false);
        }
      }, []);

      useEffect(() => {
        fetchTasks();
      }, [fetchTasks]);

      const handleAddTask = async (newTaskData) => {
        try {
          await createTask(newTaskData);
          setView('list');
          await fetchTasks();
        } catch (err) {
          setError('Gagal menambahkan tugas. Silakan coba lagi.');
          throw err; // Re-throw to inform the form component of the failure
        }
      };

      const handleToggleTask = async (id, completed) => {
        const originalTasks = [...tasks];
        const taskToUpdate = tasks.find(t => t.id === id);
        if (!taskToUpdate) return;

        const updatedTask = { ...taskToUpdate, completed };
        setTasks(tasks.map(t => (t.id === id ? updatedTask : t)));

        try {
          await updateTask(updatedTask);
        } catch (err) {
          setError('Gagal memperbarui tugas.');
          setTasks(originalTasks);
        }
      };

      const handleDeleteTask = async (id) => {
        const originalTasks = [...tasks];
        setTasks(tasks.filter(t => t.id !== id));

        try {
          await deleteTask(id);
        } catch (err) {
          setError('Gagal menghapus tugas.');
          setTasks(originalTasks);
        }
      };

      return (
        <main className="min-h-full p-4">
          {error && (
            <div className="max-w-md mx-auto bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert">
              <strong className="font-bold">Error!</strong>
              <span className="block sm:inline ml-2">{error}</span>
              <span className="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onClick={() => setError(null)}>
                <svg className="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
              </span>
            </div>
          )}
          {view === 'list' ? (
            <TaskList
              tasks={tasks}
              isLoading={isLoading}
              onToggleTask={handleToggleTask}
              onDeleteTask={handleDeleteTask}
              onShowAddTask={() => setView('add')}
            />
          ) : (
            <AddTaskForm
              onAddTask={handleAddTask}
              onCancel={() => setView('list')}
            />
          )}
        </main>
      );
    };
    
    // --- RENDER APP ---
    const rootElement = document.getElementById('root');
    if (rootElement) {
      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    }

  </script>
</body>
</html>
